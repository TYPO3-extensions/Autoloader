<?php
/**
 * Generated from Autoloader Extension.
 *
 * Do not modifiy THIS file!
 *
 * @author Carsten Biebricher <carsten.biebricher@hdnet.de>
 */
namespace HDNET\Autoloader\Xclass;

use TYPO3\CMS\Core\Utility\GeneralUtility;

/**
 * Aspect Xclass.
 *
 * @package HDNET\Autoloader\Xclass
 */
class __classname__ extends __extendedClass__ {

	/**
	 * Configuration Array for before-aspects.
	 *
	 * array(
	 *  {joinpoint} => array(
	 *          {method1}, {method2}, {method3}
	 *      )
	 * )
	 *
	 */
	protected $before = __beforeAspectsConfiguration__;

	/**
	 * Configuration Array for replace-aspects.
	 *
	 * array(
	 *  {joinpoint} => array(
	 *          {method1}, {method2}, {method3}
	 *      )
	 * )
	 *
	 */
	protected $replace = __replaceAspectsConfiguration__;

	/**
	 * Configuration Array for after-aspects.
	 *
	 * array(
	 *  {joinpoint} => array(
	 *          {method1}, {method2}, {method3}
	 *      )
	 * )
	 *
	 */
	protected $after = __afterAspectsConfiguration__;

	/**
	 * Configuration Array for throw-aspects.
	 *
	 * array(
	 *  {joinpoint} => array(
	 *          {method1}, {method2}, {method3}
	 *      )
	 * )
	 *
	 */
	protected $throw = __throwAspectsConfiguration__;

	__joinpointMethods__

	/**
	 * @param $joinpoint
	 * @param $args
	 *
	 * @return mixed
	 *
	 * @throws \Exception
	 */
	protected function aspectLogic($joinpoint, $args) {
		$arguments = array(
			'args' => $args,
			'result' => NULL
		);

		$return = NULL;
		try {
			// Aspect: before
			$arguments = $this->before($joinpoint, $arguments);

			// Aspect: replace
			$arguments = $this->replace($joinpoint, $arguments);

			// Aspect: after
			$arguments = $this->after($joinpoint, $arguments);

		} catch (\Exception $e) {
			// Aspect: throws
			$arguments = $this->throws($joinpoint, $arguments, $e);
		}

		return $arguments['result'];
	}

	/**
	 * Work the 'before' aspect. on the given joinpoint.
	 *
	 * @param string $joinpoint joinpoint in the class
	 * @param array $arguments arguments for the method defined by the joinpoint
	 *
	 * @return array $arguments
	 */
	protected function before($joinpoint, $arguments) {
		if (array_key_exists($joinpoint, $this->before)) {
			$functionStack = $this->before[strtolower($joinpoint)];

			foreach ($functionStack as $key => $configuration) {
				$arguments = $this->callAspect($configuration, $arguments);
			}
		}

		return $arguments;
	}

	/**
	 * Work the 'after' aspect. on the given joinpoint.
	 *
	 * @param string $joinpoint joinpoint in the class
	 * @param array $arguments arguments for the method defined by the joinpoint
	 *
	 * @return array $arguments
	 */
	protected function after($joinpoint, $arguments) {
		if (array_key_exists($joinpoint, $this->after)) {
			$functionStack = $this->after[strtolower($joinpoint)];

			foreach ($functionStack as $key => $configuration) {
				$arguments = $this->callAspect($configuration, $arguments);
			}
		}

		return $arguments;
	}

	/**
	 * Work the 'replace' aspect. on the given joinpoint.
	 * If the replace aspect is called, the original method is not used anymore!
	 *
	 * @param string $joinpoint joinpoint in the class
	 * @param array $arguments arguments for the method defined by the joinpoint
	 *
	 * @return array $arguments
	 */
	protected function replace($joinpoint, $arguments) {
		if (array_key_exists($joinpoint, $this->replace) && $this->replace[strtolower($joinpoint)]) {
			$functionStack = $this->replace[strtolower($joinpoint)];

			foreach ($functionStack as $key => $configuration) {
				$arguments = $this->callAspect($configuration, $arguments);
			}
		} else {
			if (array_key_exists('args', $arguments)) {
				$arguments['result'] = call_user_func_array('parent::' . $joinpoint, $arguments['args']);
			} else {
				$arguments['result'] = call_user_func_array('parent::' . $joinpoint, array());
			}
		}

		return $arguments;
	}

	/**
	 * Work the 'throw' aspect. on the given joinpoint.
	 *
	 * @param string     $joinpoint joinpoint in the class
	 * @param array      $arguments arguments for the method defined by the joinpoint
	 * @param \Exception $e
	 *
	 * @return array $arguments
	 *
	 * @throws \Exception
	 */
	protected function throws($joinpoint, $arguments, \Exception $e) {
		if (array_key_exists($joinpoint, $this->throw)) {
			$functionStack = $this->throw[strtolower($joinpoint)];

			foreach ($functionStack as $key => $configuration) {
				$arguments = $this->callAspect($configuration, $arguments);
			}
		} else {
			throw $e;
		}

		return $arguments;
	}

	/**
	 * Call the given aspect in the User-Class.
	 *
	 * @param array $configuration
	 * @param array $arguments
	 *
	 * @return array
	 */
	protected function callAspect(array $configuration, $arguments) {
		$class = GeneralUtility::makeInstance($configuration['class']);
		$return = call_user_func_array(
			array($class, $configuration['function']),
			array($this->parentClass, $arguments)
		);

		$arguments = ($return) ? $return : $arguments;

		return $arguments;
	}
}